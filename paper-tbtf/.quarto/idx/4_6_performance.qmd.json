{"title":"06 Performance","markdown":{"yaml":{"title":"06 Performance","execute":{"enabled":false}},"headingText":"Out-of-Sample Evaluation Framework","containsRefs":false,"markdown":"\n\n```{python}\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\nimport numpy as np\nimport pandas as pd\nimport sqlite3\ncons = sqlite3.connect(database=\"../../tbtf.sqlite\")\n\ncrsp = pd.read_sql_query(\n  sql=\"SELECT * FROM crsp\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n\n```\n\n\nThe TBTF strategy relies on a structurally motivated weighting scheme that reflects not only asset-specific characteristics but also investor preferences toward risk concentration and downside protection. Two key parameters govern this framework:\n\n- **Risk aversion parameter ($\\eta$)**:  \n    We employ a CRRA-type (Constant Relative Risk Aversion) transformation in the exponential weighting function, where asset weights are proportional to\n\n    $$\n    w_i \\propto \\exp\\left(\\eta \\cdot \\hat{r}_i\\right).\n    $$\n\n    Here, $\\hat{r}_i$ denotes the estimated expected return for asset $i$ based on its in-sample historical performance, typically computed as the average excess return over the past 36 months. This formulation captures the intuition that investors tend to allocate more capital to assets with higher perceived profitability, especially under risk-averse preferences.\n\n    The parameter $\\eta > 0$ reflects the degree of risk aversion or, equivalently, the strength of capital concentration toward assets with higher expected returns. A higher $\\eta$ induces more aggressive overweighting of top-ranked stocks, thereby mimicking the structural capital lock-in observed in real-world markets. In this study, we set $\\eta = 3$, which strikes a balance between diversification and concentration, and is broadly consistent with utility curvature in standard asset pricing and consumption–savings models.\n\n- **Tail probability threshold ($p$) for Omega ratio**:  \n  To quantify downside risk, we use the Omega ratio, which captures the full shape of the return distribution:\n\n  $$\n  \\Omega(p) = \\frac{\\int_p^\\infty (1 - F(r)) \\, dr}{\\int_{-\\infty}^p F(r) \\, dr}.\n  $$\n\n  The threshold $p$ defines the return level below which outcomes are considered losses. We set $p = 0.01$, corresponding to a 1% monthly return threshold—commonly adopted as the minimum acceptable return (MAR) in institutional risk management. This conservative cutoff captures meaningful left-tail risk while avoiding excessive sensitivity to extreme outliers.\n\nThe strategy is trained on a rolling 36-month in-sample window to estimate optimal exponential weights across the top decile (`state = 10`) based on lagged market capitalization. Portfolios are rebalanced quarterly (`rebalance_freq='3M'`) to reflect the long-term stickiness of capital among dominant firms, with structural filtering applied via $\\eta = 3$ and $p = 0.01$.\n\nTo rigorously test the strategy's robustness and economic significance, we conduct fully out-of-sample evaluations over two distinct macro-financial regimes:\n\n```python\nresults_pre = tbtf.backtest_pipeline(\n    crsp=crsp,\n    in_end='1999-12-31',\n    out_end='2009-12-31',\n    in_sample_months=36,\n    rebalance_freq='3M',\n    weighting_method='exponential',\n    top_n=10,\n    state=10,\n    eta=3,\n    p=0.01\n)\n\nresults_post = tbtf.backtest_pipeline(\n    crsp=crsp,\n    in_end='2013-12-31',\n    out_end='2023-12-31',\n    in_sample_months=36,\n    rebalance_freq='3M',\n    weighting_method='exponential',\n    top_n=10,\n    state=10,\n    eta=3,\n    p=0.01\n)\n```\n\n```{python}\n\n# Out-of-sample Investment\n# 10 years in pre-2010 from 2000-01\n# 10 years in post-2010 from 2004-01\n\nimport sys\nimport os\n# 현재 경로 기준으로 상위 디렉토리로 경로 추가\nsys.path.append(os.path.abspath('../..'))\n\nimport tbtf\n\nresults_pre = tbtf.backtest_pipeline(\n    crsp=crsp,\n    in_end='1999-12-31',\n    out_end='2009-12-31',\n    in_sample_months=36,\n    rebalance_freq='3M',\n    weighting_method='exponential',\n    top_n=10,\n    state=10,\n    eta=3,\n    p=0.01\n)\n\nresults_post = tbtf.backtest_pipeline(\n    crsp=crsp,\n    in_end='2013-12-31',\n    out_end='2023-12-31',\n    in_sample_months=36,\n    rebalance_freq='3M',\n    weighting_method='exponential',\n    top_n=10,\n    state=10,\n    eta=3,\n    p=0.01\n)\n\n# TBTF returns in the out-of-sample\ntbtf_returns_pre2010 = results_pre['returns'].set_index('date')['portfolio_return']\ntbtf_returns_post2010 = results_post['returns'].set_index('date')['portfolio_return']\n\n```\n\n```{python}\n\nff3 = pd.read_sql_query(\n  sql=\"SELECT * FROM ff3\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n# 날짜를 datetime 형식으로 변환\nff3['date'] = pd.to_datetime(ff3['date'])\n# 인덱스 지정\nff3.set_index('date', inplace=True)\n\n# Pre-2010: 2000–2009\nmarket_returns_pre2010 = ff3.loc['2000-01-31':'2009-12-31', 'mkt_ret']\n# Post-2010: 2014–2023\nmarket_returns_post2010 = ff3.loc['2014-01-31':'2023-12-31', 'mkt_ret']\n\n```\n\n\n## Comparative Distributional Analysis: Pre-2010 vs. Post-2010\n\nTo assess the structural evolution of market efficiency and capital concentration, we compare the TBTF portfolio's out-of-sample return distributions against the Fama-French market portfolio return, denoted as `mkt_ret`. This return series is sourced directly from the Fama-French data library and corresponds to the aggregate U.S. stock market return including dividends.\n\nThe comparison is conducted across two distinct macro-financial regimes:\n\n- **Pre-2010 period**: 2000–2009 (trained on data up to 1999)\n- **Post-2010 period**: 2014–2023 (trained on data up to 2013)\n\n```{python}\n#| fig-cap: \"Monthly Return Distribution of TBTF vs. Market (Pre-2010 vs. Post-2010)\"\n#| layout-ncol: 2\ntbtf.plot_return_distribution(tbtf_returns_pre2010, market_returns_pre2010, period_label='pre-2010')\ntbtf.plot_return_distribution(tbtf_returns_post2010, market_returns_post2010, period_label='post-2010')\n```\n\nDistributional Shifts from this comparative analysis are as follows:\n\n- In the pre-2010 window, the TBTF and market portfolios exhibit similar interquartile ranges (IQR), indicating comparable volatility levels. However, the mean return is higher for the market, suggesting that TBTF underperformed not due to risk but due to return inefficiency. TBTF’s distribution is relatively symmetric, while the market shows mild left-skewness. Notably, TBTF exhibits high kurtosis, indicating heavier tails and more frequent extreme outcomes, both positive and negative.\n- In the post-2010 period, the relationship reverses. While the market portfolio’s standard deviation declines, TBTF not only achieves a higher mean return, but also exhibits superior interquartile positioning—especially in the median and upper quartile. The lower quartile remains similar across both, indicating equivalent downside frequency, but TBTF captures the upside more effectively. In terms of shape, the market distribution becomes more symmetric, whereas TBTF turns left-skewed, reflecting an asymmetric probability mass concentrated just above the loss threshold—consistent with convex return dynamics and infrequent but large outperformance events.\n- In summary, the roles of the two distributions are structurally inverted across regimes. Pre-2010, TBTF resembled a symmetrical bell-shaped curve with fat tails, while the market was mildly skewed. Post-2010, the market distribution becomes tighter and more symmetric, whereas TBTF becomes more asymmetric and wider, capturing structural convexity in return outcomes. This shift aligns with a regime transition in capital flows and market microstructure following the QE era.\n\n\n```{python}\n#| fig-cap: \"Price Level Comparison: TBTF vs. Market (Pre-2010 vs. Post-2010)\"\n#| layout-ncol: 2\ntbtf.plot_price_level(tbtf_returns_pre2010, market_returns_pre2010, start_date='2000-01-01', end_date='2009-12-31')\ntbtf.plot_price_level(tbtf_returns_post2010, market_returns_post2010, start_date='2004-01-01', end_date='2023-12-31')\n```\n\n\n\n```{python}\n\npre_index = pd.read_sql_query(\n  sql=\"SELECT * FROM pre_index\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n\npost_index = pd.read_sql_query(\n  sql=\"SELECT * FROM post_index\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n\npost_ff = pd.read_sql_query(\n  sql=\"SELECT * FROM post_ff\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n\n```\n\n\n## Other Benchmark Comparison\n\nTo further contextualize the performance of the TBTF strategy, we compare it against a wide set of benchmark portfolios, including major U.S. equity indices and Fama-French style-sorted portfolios. Each comparison is presented as a paired figure showing the **monthly return distribution (left)** and the **cumulative price level evolution (right)**.\n\n```{python}\n#| fig-cap: \"TBTF vs. Benchmarks (Pre-2010)\"\ntbtf.plot_benchmark_comparison(tbtf_returns_pre2010, pre_index, period_label='pre-2010')\n```\n\n```{python}\n#| fig-cap: \"TBTF vs. Benchmarks (Post-2010)\"\ntbtf.plot_benchmark_comparison(tbtf_returns_post2010, post_index, period_label='post-2010')\ntbtf.plot_benchmark_comparison(tbtf_returns_post2010, post_ff, period_label='post-2010 (FF)')\n```\n\n### Pre-2010: Market Dominance and Diversification\n\nIn the pre-2010 sample, TBTF **underperforms** all major benchmarks both in terms of average monthly returns and cumulative price levels:\n\n- Compared to the **Dow Jones Industrial Average (^DJI)** and the **Nasdaq 100 (^NDX)**, TBTF lags significantly in mean returns, with its average return even falling below zero. This underperformance is visible in both the return histogram and the flattened price trajectory.\n- The **shape of the return distributions** further illustrates this divergence. While ^DJI displays a concentrated bell-shaped curve reflecting strong diversification benefits across sectors, TBTF's distribution is wider and flatter, and ^NDX’s distribution appears even flatter and fatter-tailed—consistent with its tech-heavy composition and lower effective diversification.\n- These findings imply that during this regime, the structural capital lock-in emphasized by TBTF was not yet rewarded, and sectoral diversification still played a dominant role in driving returns.\n\n### Post-2010: Structural Convexity and Breakaway Performance\n\nPost-2010, the TBTF strategy decisively **outperforms** all benchmark portfolios, not only in cumulative performance but also in distributional characteristics:\n\n- Most strikingly, **TBTF’s return distribution exhibits bi-modality**, a rare phenomenon in empirical asset returns. Both modes are positive, with the second, larger mode emerging after recovering from a brief period of negative returns during late 2021 to early 2022. This distributional structure reflects a convex outcome space where moderate and large gains dominate.\n- **DIA**, which tracks the 30 blue-chip constituents of ^DJI, displays a symmetric but left-skewed return profile and a relatively muted price level curve. By contrast, TBTF rapidly diverges post-2019, widening the performance gap year by year.\n- **QQQ**, representing the Nasdaq 100 ETF, initially tracks TBTF closely between 2014 and 2020. However, since 2021, TBTF begins to **consistently outperform QQQ**, suggesting a regime shift where **capital dominance surpasses even tech momentum**.\n- **SPY**, representing the broader S&P 500, sits between DIA and QQQ in both return level and distributional shape. Its distribution approximates a classic symmetric bell curve, but lacks the convexity and upside concentration observed in TBTF.\n- The **return distribution of SPY** is unimodal and centered, offering a useful contrast to the dual-modal, right-tilted structure of TBTF.\n\n### Post-2010: Fama-French Portfolios (ME × PRIOR)\n\nWe also include value-weighted and equal-weighted Fama-French 3x2 portfolios constructed from top 20% market cap stocks (ME5) sorted by prior return (PRIOR1–5):\n\n- Among value-weighted portfolios, **PRIOR5 (ff_b)** performs best, followed by **PRIOR3 (ff_m)** and **PRIOR1 (ff_s)**. This gradient suggests a standard momentum pattern. However, **TBTF outpaces all of them**, with its **price level evolving geometrically**, while FF portfolios show **only linear growth trends** over the same horizon.\n- Among equal-weighted portfolios, performance is more muted. Notably, **ff_e_s** (equal-weighted ME5 × PRIOR1) performs slightly better than its value-weighted counterpart, suggesting that **in low-momentum groups, idiosyncratic selection beats size dominance**.\n- Yet again, **none of the FF portfolios, whether value- or equal-weighted, come close to TBTF’s performance**, emphasizing that TBTF's structural logic—built on capital persistence and lock-in rather than factor exposure—offers a fundamentally different return engine.\n\n\n### Interpretation\n\nThe above comparisons reinforce the hypothesis that **post-2010 capital markets have undergone a structural realignment**. In this new regime, traditional sources of diversification and factor exposure lose explanatory power, while the concentration of capital into a select few entities generates persistent excess returns. The TBTF strategy captures this realignment directly through its construction, thereby achieving outperformance not through luck or timing, but by aligning itself with the **new architecture of capital allocation** in the post-QE world.\n\n\n\n## Risk-Adjusted Performance Metrics\n\nTo benchmark the performance of the TBTF strategy against traditional market indices, we compute a suite of risk-adjusted performance metrics over both the **pre-2010** and **post-2010** periods. These include:\n\n- **Sharpe ratio**: Mean excess return normalized by standard deviation.\n- **Sortino ratio**: Return per unit of downside deviation, focusing on losses.\n- **Omega ratio**: A distribution-sensitive metric measuring the ratio of gains above a threshold to losses below it.\n- **Maximum drawdown**: Largest peak-to-trough loss during the sample period.\n- **Expected CRRA utility**: A model-based expected utility under constant relative risk aversion.\n\nThe final metric—Expected CRRA Utility—provides a theoretically grounded welfare measure, widely used in academic finance. Unlike Sharpe or Sortino ratios, CRRA utility reflects higher-order moments of the return distribution, such as skewness and kurtosis, which are especially relevant for TBTF's left-skewed but convex payoff structure. For a CRRA coefficient $\\gamma > 0$, utility is computed as:\n\n$$\n\\mathbb{E}[U(W)] = \\frac{1}{1 - \\gamma} \\cdot \\mathbb{E}\\left[(1 + r)^{1 - \\gamma}\\right],\n$$\n\nwhere $r$ is the gross monthly return. We set $\\gamma = 3$ to reflect moderate risk aversion, consistent with our strategy design.\n\nTables below report the performance metrics for selected portfolios, sorted by **Expected CRRA Utility**.\n\n\n### Pre-2010 Period\n\n```{python}\nreturns_dict_pre2010 = {\n    'TBTF': tbtf_returns_pre2010,\n    'DJI': pre_index['^DJI'],\n    'NDX': pre_index['^NDX']\n}\n\n#| tbl-cap: \"Risk-Adjusted Performance Comparison (Pre-2010)\"\ntbtf.generate_performance_table(returns_dict_pre2010).sort_values(by='Expected CRRA', ascending=False)\n```\n\nThe risk-adjusted performance metrics for the pre-2010 period reveal that the TBTF strategy significantly underperforms relative to traditional benchmarks such as the Dow Jones Industrial Average (DJI) and Nasdaq 100 (NDX). While both benchmarks deliver positive annualized returns—5.3% for DJI and 8.8% for NDX—TBTF produces a **negative average return of -10.2%**, resulting in uniformly negative values for all performance ratios.\n\n- **Sharpe and Sortino ratios** for TBTF are both negative, indicating that the strategy failed to compensate for volatility and downside risk during this period.\n- The **Omega ratio** of TBTF (0.40) is substantially lower than that of NDX (1.03) and DJI (0.76), further emphasizing poor downside-adjusted performance.\n- **Maximum drawdown**, surprisingly, is less severe for TBTF (-31.2%) than for NDX (-81.1%), though this is largely due to TBTF's failure to experience large upswings, not resilience in downturns.\n- The **Expected CRRA utility** for TBTF is negative (-0.0119), in stark contrast to the positive values for DJI (+0.0021). This indicates that, for a moderately risk-averse investor ($\\gamma = 3$), TBTF would have been **strictly dominated** by holding a benchmark index.\n- In terms of distribution shape, TBTF displays **near-zero skewness** and **moderate excess kurtosis**, suggesting symmetric but fat-tailed returns. This is consistent with the earlier observation that pre-2010 TBTF returns resembled a bell curve with heavy tails, whereas NDX was left-skewed and more extreme in both tails.\n\nTaken together, these results indicate that during the pre-QE, industrial-cycle-driven market regime, the structural logic behind TBTF—capital lock-in and size dominance—did not translate into superior returns. Instead, diversification (as in DJI) and tech momentum (as in NDX) dominated portfolio performance.\n\n\n### Interpretation: Post-2010 Period\n\n\n```{python}\n\nreturns_dict_post2010 = {\n    'TBTF': tbtf_returns_post2010,\n    'DIA': post_index['DIA'],\n    'QQQ': post_index['QQQ'],\n    'SPY': post_index['SPY'],\n    'VTI': post_index['VTI']\n}\n\n#| tbl-cap: \"Risk-Adjusted Performance Comparison (Post-2010)\"\ntbtf.generate_performance_table(returns_dict_post2010).sort_values(by='Expected CRRA', ascending=False)\n\n```\n\nThe post-2010 performance metrics tell a dramatically different story. In this regime—characterized by sustained quantitative easing, historically low interest rates, and capital concentration—the TBTF strategy not only outperforms all benchmark portfolios in raw returns, but does so **decisively across all risk-adjusted dimensions**.\n\n- **Annualized return** for TBTF reaches **35.8%**, more than twice that of QQQ (16.9%) and over three times that of SPY, VTI, and DIA (all below 11%). \n- The **Sharpe ratio** of TBTF (1.57) is by far the highest, indicating a return per unit of volatility unmatched by any benchmark. More notably, the **Sortino ratio** (2.21) and **Omega ratio** (2.17) reveal TBTF’s **asymmetric protection against downside**, a signature feature of its convex payoff structure.\n- **Maximum drawdown** is relatively modest at -21.0%, despite the high return level, and the **Calmar ratio** (1.70) reflects this efficiency. By comparison, QQQ suffers a deeper drawdown (-33.1%) with only a third of the Calmar ratio.\n- Crucially, the **Expected CRRA utility** for TBTF is **+0.0214**, more than double that of QQQ (+0.0103), and significantly above other diversified portfolios (SPY: +0.0067, VTI: +0.0065, DIA: +0.0059). For a moderately risk-averse investor ($\\gamma = 3$), TBTF represents a clear welfare-maximizing choice.\n- From a distributional perspective, TBTF shows **mild negative skewness (Fisher: -0.35)** and **positive excess kurtosis (1.13)**, consistent with earlier evidence of **bimodality and tail concentration**. In contrast, SPY and VTI are more symmetric but exhibit thinner tails, which limits their upside potential.\n- QQQ, while historically strong, demonstrates a **flattened distribution with lower Omega and Sortino ratios**, suggesting diminished downside protection relative to TBTF in recent years.\n\nThese results reinforce the view that the post-2010 market environment systematically rewarded capital dominance over traditional diversification or momentum strategies. TBTF’s success is not just statistically significant, but economically meaningful across every major dimension of portfolio evaluation—returns, risk, asymmetry, drawdowns, and investor utility.\n\n\n## Drawdown and Turnover\n\nIn this section, we evaluate the **downside risk exposure** and **implementation feasibility** of the TBTF strategy. Two key dimensions are analyzed:\n\n- **Maximum Drawdown**: Measures the largest peak-to-trough decline in cumulative return over the evaluation period.\n- **Portfolio Turnover**: Assesses the degree of rebalancing required, with lower turnover implying lower transaction costs and higher implementability.\n\n### Drawdown Dynamics\n\n> While TBTF suffered deeper losses than ^DJI during the 2008 crisis, its post-2010 drawdown profile proved significantly more resilient than traditional style portfolios and benchmark ETFs, with a rapid recovery trajectory by 2023.\n\n```{python}\n\nimport matplotlib.pyplot as plt\nimport matplotlib.dates as mdates\n\ndef compute_drawdown(return_series: pd.Series) -> pd.Series:\n    cumulative = (1 + return_series).cumprod()\n    peak = cumulative.cummax()\n    drawdown = (cumulative - peak) / peak\n    return drawdown\n\ndef plot_drawdown(tbtf_returns_raw, benchmark_df, title=\"Drawdown Profile\"):\n    plt.figure(figsize=(10, 4))\n\n    # --- TBTF 처리 ---\n    if isinstance(tbtf_returns_raw, pd.DataFrame):\n        if 'date' in tbtf_returns_raw.columns:\n            tbtf_returns_raw = tbtf_returns_raw.set_index(pd.to_datetime(tbtf_returns_raw['date']))\n        tbtf_returns = tbtf_returns_raw.select_dtypes(include='number').iloc[:, 0]\n    elif isinstance(tbtf_returns_raw, pd.Series):\n        tbtf_returns = tbtf_returns_raw\n    else:\n        raise TypeError(\"tbtf_returns_raw must be DataFrame or Series.\")\n\n    tbtf_returns.index = pd.to_datetime(tbtf_returns.index)\n    tbtf_drawdown = compute_drawdown(tbtf_returns)\n    plt.plot(tbtf_drawdown.index, tbtf_drawdown.values, label='TBTF', color='black', linewidth=2)\n\n    # --- 벤치마크 DataFrame 처리 ---\n    if 'date' in benchmark_df.columns:\n        benchmark_df = benchmark_df.set_index(pd.to_datetime(benchmark_df['date']))\n    else:\n        benchmark_df.index = pd.to_datetime(benchmark_df.index)\n\n    benchmark_df = benchmark_df.select_dtypes(include='number')  # 숫자만\n\n    for col in benchmark_df.columns:\n        series = benchmark_df[col].reindex(tbtf_returns.index)\n        if series.isna().all():\n            continue  # 완전히 비어있으면 skip\n        drawdown = compute_drawdown(series)\n        plt.plot(drawdown.index, drawdown.values, label=col, alpha=0.7)\n\n    # --- x축 날짜 포맷 ---\n    ax = plt.gca()\n    ax.xaxis.set_major_locator(mdates.YearLocator())\n    ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y'))\n    plt.xticks(rotation=45)\n\n    # --- 마무리 ---\n    plt.title(title)\n    plt.ylabel(\"Drawdown\")\n    plt.xlabel(\"Date\")\n    plt.legend()\n    plt.grid(True)\n    plt.tight_layout()\n    plt.show()\n\n```\n\n#### Pre-2010 Period (2000–2009)\n```{python}\nplot_drawdown(results_pre['returns'], pre_index, title=\"Drawdown Profile (Pre-2010)\")\n```\nDuring the first decade, the TBTF strategy underperformed the Dow Jones Industrial Average (^DJI) in terms of drawdown resilience. While TBTF, ^DJI, and ^NDX all exhibited relatively similar patterns prior to the 2008 Global Financial Crisis, the drawdown plot reveals that TBTF experienced a sharper decline during the crisis episode. This suggests that TBTF’s concentrated exposure to the largest-cap firms provided limited diversification benefit during systemic tail events, particularly in contrast to the more balanced composition of the ^DJI.\n\n\n#### Post-2010 Period (2014–2023)\n\n```{python}\nplot_drawdown(results_post['returns'], post_index, title=\"Drawdown Profile (Post-2010)\")\nplot_drawdown(results_post['returns'], post_ff, title=\"Drawdown Profile (Post-2010)\")\n\n```\n\nIn contrast, during the second decade, TBTF demonstrated superior drawdown performance relative to all benchmark ETFs, particularly until late 2021. The strategy maintained shallow drawdowns through several volatility cycles, including the COVID-19 shock and inflation-driven rate adjustments, reflecting its structural bias toward persistent market leaders.\n\nHowever, in late 2021, TBTF experienced a notable drawdown phase, closely mirrored by the QQQ, indicating common exposure to high-growth tech stocks. Despite this synchronized decline, both TBTF and QQQ rebounded strongly by 2023, surpassing prior peaks.\n\nNotably, the Fama-French style-sorted portfolios (ME×PRIOR) exhibited deeper and more persistent drawdowns throughout the post-2010 period. These portfolios consistently underperformed TBTF in drawdown magnitude, highlighting the limitations of conventional size- and momentum-based constructions in capturing the structural dominance embedded in TBTF’s selection mechanism.\n\n\n\n### TBTF Turnover\n\n```{python}\nimport matplotlib.pyplot as plt\nimport matplotlib.dates as mdates\n\ndef plot_turnover(turnover_df, title=\"TBTF Turnover Over Time\"):\n    df = turnover_df.copy()\n    df['rebalance_date'] = pd.to_datetime(df['rebalance_date'])\n    df.set_index('rebalance_date', inplace=True)\n\n    plt.figure(figsize=(10, 3))\n    plt.plot(df.index, df['turnover'], marker='o', color='darkgreen', linewidth=1.5)\n\n    # x축 날짜 format\n    ax = plt.gca()\n    ax.xaxis.set_major_locator(mdates.YearLocator())\n    ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y'))\n    plt.xticks(rotation=45)\n\n    plt.title(title)\n    plt.ylabel(\"Turnover (sum of abs weight changes)\")\n    plt.xlabel(\"Rebalance Date\")\n    plt.grid(True)\n    plt.tight_layout()\n    plt.show()\n\n```\n\n```{python}\n# Pre-2010 turnover plot\nplot_turnover(results_pre['turnover'].iloc[:-1], title=\"TBTF Turnover (Pre-2010)\")\n\n# Post-2010 turnover plot\nplot_turnover(results_post['turnover'].iloc[:-1], title=\"TBTF Turnover (Post-2010)\")\n\n```\n\nThe TBTF strategy rebalances quarterly, yet maintains a remarkably steady turnover profile across both subperiods, highlighting its structural persistence and practical implementability.\n\n| Period      | Mean Turnover | Std Dev |\n|-------------|---------------|---------|\n| Pre-2010    | 0.22          | 0.12    |\n| Post-2010   | 0.15          | 0.10    |\n\nThis low and stable turnover suggests that, although the strategy updates weights every three months, the **actual reallocation of capital is limited**. This is particularly meaningful given TBTF’s concentrated structure: the top 10 stocks by market capitalization.\n\nTo further explore the internal mechanics of turnover, we examine the group-rank positions of stocks entering and exiting the portfolio:\n\n- The average **`max_diff_group_rank`** is approximately **1–2**, indicating that stocks removed from the TBTF portfolio were typically ranked **9th or 10th** before exit.  \n- The average **`min_diff_group_rank`** is approximately **3–3.5**, suggesting that newly entering stocks typically displaced members ranked around **6th or 7th**.\n\nThis pattern implies a **core–fringe structure** within the TBTF portfolio:  \nthe **top-ranked firms (1st–5th)** exhibit strong persistence, while changes are concentrated at the margin of the selection, reducing both instability and turnover-related costs.\n\n\n\n## Implications\n\nThe TBTF strategy consistently delivers strong out-of-sample performance, characterized by high risk-adjusted returns, stable drawdowns, and low turnover. These patterns persist across both pre- and post-2010 market regimes and cannot be explained by conventional size or momentum factors.\n\nWhat distinguishes TBTF is not merely statistical outperformance but its reflection of **a persistent capital hierarchy**, in which dominant firms retain market share through institutional mechanisms rather than pure productivity or risk-taking.\n\nWhereas traditional models explain return premia through exposure to priced risk, TBTF accumulates return through insulation from risk—via passive flows, platform effects, and embedded expectations. In this sense, **market power does not demand a premium—it neutralizes the need for one**.\n\nThis invites a reframing of modern asset pricing:  \n> *Return without risk is no longer a puzzle, but a feature of financial capitalism.*\n\nReaders seeking formal modeling of regime persistence and capital asymmetry are referred to [Section 4](4_4_structure.qmd). Here, we have focused on empirical validation, leaving latent structure estimation to the structural section.\n\nIn the following section, we assess whether TBTF’s performance is **robust to alternative specifications**: selection cutoffs, rebalancing intervals, weighting schemes, and estimation windows. This stress-testing is essential to distinguish true structural effects from parameter-driven artifacts.\n","srcMarkdownNoYaml":"\n\n```{python}\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\nimport numpy as np\nimport pandas as pd\nimport sqlite3\ncons = sqlite3.connect(database=\"../../tbtf.sqlite\")\n\ncrsp = pd.read_sql_query(\n  sql=\"SELECT * FROM crsp\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n\n```\n\n## Out-of-Sample Evaluation Framework\n\nThe TBTF strategy relies on a structurally motivated weighting scheme that reflects not only asset-specific characteristics but also investor preferences toward risk concentration and downside protection. Two key parameters govern this framework:\n\n- **Risk aversion parameter ($\\eta$)**:  \n    We employ a CRRA-type (Constant Relative Risk Aversion) transformation in the exponential weighting function, where asset weights are proportional to\n\n    $$\n    w_i \\propto \\exp\\left(\\eta \\cdot \\hat{r}_i\\right).\n    $$\n\n    Here, $\\hat{r}_i$ denotes the estimated expected return for asset $i$ based on its in-sample historical performance, typically computed as the average excess return over the past 36 months. This formulation captures the intuition that investors tend to allocate more capital to assets with higher perceived profitability, especially under risk-averse preferences.\n\n    The parameter $\\eta > 0$ reflects the degree of risk aversion or, equivalently, the strength of capital concentration toward assets with higher expected returns. A higher $\\eta$ induces more aggressive overweighting of top-ranked stocks, thereby mimicking the structural capital lock-in observed in real-world markets. In this study, we set $\\eta = 3$, which strikes a balance between diversification and concentration, and is broadly consistent with utility curvature in standard asset pricing and consumption–savings models.\n\n- **Tail probability threshold ($p$) for Omega ratio**:  \n  To quantify downside risk, we use the Omega ratio, which captures the full shape of the return distribution:\n\n  $$\n  \\Omega(p) = \\frac{\\int_p^\\infty (1 - F(r)) \\, dr}{\\int_{-\\infty}^p F(r) \\, dr}.\n  $$\n\n  The threshold $p$ defines the return level below which outcomes are considered losses. We set $p = 0.01$, corresponding to a 1% monthly return threshold—commonly adopted as the minimum acceptable return (MAR) in institutional risk management. This conservative cutoff captures meaningful left-tail risk while avoiding excessive sensitivity to extreme outliers.\n\nThe strategy is trained on a rolling 36-month in-sample window to estimate optimal exponential weights across the top decile (`state = 10`) based on lagged market capitalization. Portfolios are rebalanced quarterly (`rebalance_freq='3M'`) to reflect the long-term stickiness of capital among dominant firms, with structural filtering applied via $\\eta = 3$ and $p = 0.01$.\n\nTo rigorously test the strategy's robustness and economic significance, we conduct fully out-of-sample evaluations over two distinct macro-financial regimes:\n\n```python\nresults_pre = tbtf.backtest_pipeline(\n    crsp=crsp,\n    in_end='1999-12-31',\n    out_end='2009-12-31',\n    in_sample_months=36,\n    rebalance_freq='3M',\n    weighting_method='exponential',\n    top_n=10,\n    state=10,\n    eta=3,\n    p=0.01\n)\n\nresults_post = tbtf.backtest_pipeline(\n    crsp=crsp,\n    in_end='2013-12-31',\n    out_end='2023-12-31',\n    in_sample_months=36,\n    rebalance_freq='3M',\n    weighting_method='exponential',\n    top_n=10,\n    state=10,\n    eta=3,\n    p=0.01\n)\n```\n\n```{python}\n\n# Out-of-sample Investment\n# 10 years in pre-2010 from 2000-01\n# 10 years in post-2010 from 2004-01\n\nimport sys\nimport os\n# 현재 경로 기준으로 상위 디렉토리로 경로 추가\nsys.path.append(os.path.abspath('../..'))\n\nimport tbtf\n\nresults_pre = tbtf.backtest_pipeline(\n    crsp=crsp,\n    in_end='1999-12-31',\n    out_end='2009-12-31',\n    in_sample_months=36,\n    rebalance_freq='3M',\n    weighting_method='exponential',\n    top_n=10,\n    state=10,\n    eta=3,\n    p=0.01\n)\n\nresults_post = tbtf.backtest_pipeline(\n    crsp=crsp,\n    in_end='2013-12-31',\n    out_end='2023-12-31',\n    in_sample_months=36,\n    rebalance_freq='3M',\n    weighting_method='exponential',\n    top_n=10,\n    state=10,\n    eta=3,\n    p=0.01\n)\n\n# TBTF returns in the out-of-sample\ntbtf_returns_pre2010 = results_pre['returns'].set_index('date')['portfolio_return']\ntbtf_returns_post2010 = results_post['returns'].set_index('date')['portfolio_return']\n\n```\n\n```{python}\n\nff3 = pd.read_sql_query(\n  sql=\"SELECT * FROM ff3\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n# 날짜를 datetime 형식으로 변환\nff3['date'] = pd.to_datetime(ff3['date'])\n# 인덱스 지정\nff3.set_index('date', inplace=True)\n\n# Pre-2010: 2000–2009\nmarket_returns_pre2010 = ff3.loc['2000-01-31':'2009-12-31', 'mkt_ret']\n# Post-2010: 2014–2023\nmarket_returns_post2010 = ff3.loc['2014-01-31':'2023-12-31', 'mkt_ret']\n\n```\n\n\n## Comparative Distributional Analysis: Pre-2010 vs. Post-2010\n\nTo assess the structural evolution of market efficiency and capital concentration, we compare the TBTF portfolio's out-of-sample return distributions against the Fama-French market portfolio return, denoted as `mkt_ret`. This return series is sourced directly from the Fama-French data library and corresponds to the aggregate U.S. stock market return including dividends.\n\nThe comparison is conducted across two distinct macro-financial regimes:\n\n- **Pre-2010 period**: 2000–2009 (trained on data up to 1999)\n- **Post-2010 period**: 2014–2023 (trained on data up to 2013)\n\n```{python}\n#| fig-cap: \"Monthly Return Distribution of TBTF vs. Market (Pre-2010 vs. Post-2010)\"\n#| layout-ncol: 2\ntbtf.plot_return_distribution(tbtf_returns_pre2010, market_returns_pre2010, period_label='pre-2010')\ntbtf.plot_return_distribution(tbtf_returns_post2010, market_returns_post2010, period_label='post-2010')\n```\n\nDistributional Shifts from this comparative analysis are as follows:\n\n- In the pre-2010 window, the TBTF and market portfolios exhibit similar interquartile ranges (IQR), indicating comparable volatility levels. However, the mean return is higher for the market, suggesting that TBTF underperformed not due to risk but due to return inefficiency. TBTF’s distribution is relatively symmetric, while the market shows mild left-skewness. Notably, TBTF exhibits high kurtosis, indicating heavier tails and more frequent extreme outcomes, both positive and negative.\n- In the post-2010 period, the relationship reverses. While the market portfolio’s standard deviation declines, TBTF not only achieves a higher mean return, but also exhibits superior interquartile positioning—especially in the median and upper quartile. The lower quartile remains similar across both, indicating equivalent downside frequency, but TBTF captures the upside more effectively. In terms of shape, the market distribution becomes more symmetric, whereas TBTF turns left-skewed, reflecting an asymmetric probability mass concentrated just above the loss threshold—consistent with convex return dynamics and infrequent but large outperformance events.\n- In summary, the roles of the two distributions are structurally inverted across regimes. Pre-2010, TBTF resembled a symmetrical bell-shaped curve with fat tails, while the market was mildly skewed. Post-2010, the market distribution becomes tighter and more symmetric, whereas TBTF becomes more asymmetric and wider, capturing structural convexity in return outcomes. This shift aligns with a regime transition in capital flows and market microstructure following the QE era.\n\n\n```{python}\n#| fig-cap: \"Price Level Comparison: TBTF vs. Market (Pre-2010 vs. Post-2010)\"\n#| layout-ncol: 2\ntbtf.plot_price_level(tbtf_returns_pre2010, market_returns_pre2010, start_date='2000-01-01', end_date='2009-12-31')\ntbtf.plot_price_level(tbtf_returns_post2010, market_returns_post2010, start_date='2004-01-01', end_date='2023-12-31')\n```\n\n\n\n```{python}\n\npre_index = pd.read_sql_query(\n  sql=\"SELECT * FROM pre_index\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n\npost_index = pd.read_sql_query(\n  sql=\"SELECT * FROM post_index\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n\npost_ff = pd.read_sql_query(\n  sql=\"SELECT * FROM post_ff\",\n  con=cons,\n  parse_dates={\"date\"}\n)\n\n```\n\n\n## Other Benchmark Comparison\n\nTo further contextualize the performance of the TBTF strategy, we compare it against a wide set of benchmark portfolios, including major U.S. equity indices and Fama-French style-sorted portfolios. Each comparison is presented as a paired figure showing the **monthly return distribution (left)** and the **cumulative price level evolution (right)**.\n\n```{python}\n#| fig-cap: \"TBTF vs. Benchmarks (Pre-2010)\"\ntbtf.plot_benchmark_comparison(tbtf_returns_pre2010, pre_index, period_label='pre-2010')\n```\n\n```{python}\n#| fig-cap: \"TBTF vs. Benchmarks (Post-2010)\"\ntbtf.plot_benchmark_comparison(tbtf_returns_post2010, post_index, period_label='post-2010')\ntbtf.plot_benchmark_comparison(tbtf_returns_post2010, post_ff, period_label='post-2010 (FF)')\n```\n\n### Pre-2010: Market Dominance and Diversification\n\nIn the pre-2010 sample, TBTF **underperforms** all major benchmarks both in terms of average monthly returns and cumulative price levels:\n\n- Compared to the **Dow Jones Industrial Average (^DJI)** and the **Nasdaq 100 (^NDX)**, TBTF lags significantly in mean returns, with its average return even falling below zero. This underperformance is visible in both the return histogram and the flattened price trajectory.\n- The **shape of the return distributions** further illustrates this divergence. While ^DJI displays a concentrated bell-shaped curve reflecting strong diversification benefits across sectors, TBTF's distribution is wider and flatter, and ^NDX’s distribution appears even flatter and fatter-tailed—consistent with its tech-heavy composition and lower effective diversification.\n- These findings imply that during this regime, the structural capital lock-in emphasized by TBTF was not yet rewarded, and sectoral diversification still played a dominant role in driving returns.\n\n### Post-2010: Structural Convexity and Breakaway Performance\n\nPost-2010, the TBTF strategy decisively **outperforms** all benchmark portfolios, not only in cumulative performance but also in distributional characteristics:\n\n- Most strikingly, **TBTF’s return distribution exhibits bi-modality**, a rare phenomenon in empirical asset returns. Both modes are positive, with the second, larger mode emerging after recovering from a brief period of negative returns during late 2021 to early 2022. This distributional structure reflects a convex outcome space where moderate and large gains dominate.\n- **DIA**, which tracks the 30 blue-chip constituents of ^DJI, displays a symmetric but left-skewed return profile and a relatively muted price level curve. By contrast, TBTF rapidly diverges post-2019, widening the performance gap year by year.\n- **QQQ**, representing the Nasdaq 100 ETF, initially tracks TBTF closely between 2014 and 2020. However, since 2021, TBTF begins to **consistently outperform QQQ**, suggesting a regime shift where **capital dominance surpasses even tech momentum**.\n- **SPY**, representing the broader S&P 500, sits between DIA and QQQ in both return level and distributional shape. Its distribution approximates a classic symmetric bell curve, but lacks the convexity and upside concentration observed in TBTF.\n- The **return distribution of SPY** is unimodal and centered, offering a useful contrast to the dual-modal, right-tilted structure of TBTF.\n\n### Post-2010: Fama-French Portfolios (ME × PRIOR)\n\nWe also include value-weighted and equal-weighted Fama-French 3x2 portfolios constructed from top 20% market cap stocks (ME5) sorted by prior return (PRIOR1–5):\n\n- Among value-weighted portfolios, **PRIOR5 (ff_b)** performs best, followed by **PRIOR3 (ff_m)** and **PRIOR1 (ff_s)**. This gradient suggests a standard momentum pattern. However, **TBTF outpaces all of them**, with its **price level evolving geometrically**, while FF portfolios show **only linear growth trends** over the same horizon.\n- Among equal-weighted portfolios, performance is more muted. Notably, **ff_e_s** (equal-weighted ME5 × PRIOR1) performs slightly better than its value-weighted counterpart, suggesting that **in low-momentum groups, idiosyncratic selection beats size dominance**.\n- Yet again, **none of the FF portfolios, whether value- or equal-weighted, come close to TBTF’s performance**, emphasizing that TBTF's structural logic—built on capital persistence and lock-in rather than factor exposure—offers a fundamentally different return engine.\n\n\n### Interpretation\n\nThe above comparisons reinforce the hypothesis that **post-2010 capital markets have undergone a structural realignment**. In this new regime, traditional sources of diversification and factor exposure lose explanatory power, while the concentration of capital into a select few entities generates persistent excess returns. The TBTF strategy captures this realignment directly through its construction, thereby achieving outperformance not through luck or timing, but by aligning itself with the **new architecture of capital allocation** in the post-QE world.\n\n\n\n## Risk-Adjusted Performance Metrics\n\nTo benchmark the performance of the TBTF strategy against traditional market indices, we compute a suite of risk-adjusted performance metrics over both the **pre-2010** and **post-2010** periods. These include:\n\n- **Sharpe ratio**: Mean excess return normalized by standard deviation.\n- **Sortino ratio**: Return per unit of downside deviation, focusing on losses.\n- **Omega ratio**: A distribution-sensitive metric measuring the ratio of gains above a threshold to losses below it.\n- **Maximum drawdown**: Largest peak-to-trough loss during the sample period.\n- **Expected CRRA utility**: A model-based expected utility under constant relative risk aversion.\n\nThe final metric—Expected CRRA Utility—provides a theoretically grounded welfare measure, widely used in academic finance. Unlike Sharpe or Sortino ratios, CRRA utility reflects higher-order moments of the return distribution, such as skewness and kurtosis, which are especially relevant for TBTF's left-skewed but convex payoff structure. For a CRRA coefficient $\\gamma > 0$, utility is computed as:\n\n$$\n\\mathbb{E}[U(W)] = \\frac{1}{1 - \\gamma} \\cdot \\mathbb{E}\\left[(1 + r)^{1 - \\gamma}\\right],\n$$\n\nwhere $r$ is the gross monthly return. We set $\\gamma = 3$ to reflect moderate risk aversion, consistent with our strategy design.\n\nTables below report the performance metrics for selected portfolios, sorted by **Expected CRRA Utility**.\n\n\n### Pre-2010 Period\n\n```{python}\nreturns_dict_pre2010 = {\n    'TBTF': tbtf_returns_pre2010,\n    'DJI': pre_index['^DJI'],\n    'NDX': pre_index['^NDX']\n}\n\n#| tbl-cap: \"Risk-Adjusted Performance Comparison (Pre-2010)\"\ntbtf.generate_performance_table(returns_dict_pre2010).sort_values(by='Expected CRRA', ascending=False)\n```\n\nThe risk-adjusted performance metrics for the pre-2010 period reveal that the TBTF strategy significantly underperforms relative to traditional benchmarks such as the Dow Jones Industrial Average (DJI) and Nasdaq 100 (NDX). While both benchmarks deliver positive annualized returns—5.3% for DJI and 8.8% for NDX—TBTF produces a **negative average return of -10.2%**, resulting in uniformly negative values for all performance ratios.\n\n- **Sharpe and Sortino ratios** for TBTF are both negative, indicating that the strategy failed to compensate for volatility and downside risk during this period.\n- The **Omega ratio** of TBTF (0.40) is substantially lower than that of NDX (1.03) and DJI (0.76), further emphasizing poor downside-adjusted performance.\n- **Maximum drawdown**, surprisingly, is less severe for TBTF (-31.2%) than for NDX (-81.1%), though this is largely due to TBTF's failure to experience large upswings, not resilience in downturns.\n- The **Expected CRRA utility** for TBTF is negative (-0.0119), in stark contrast to the positive values for DJI (+0.0021). This indicates that, for a moderately risk-averse investor ($\\gamma = 3$), TBTF would have been **strictly dominated** by holding a benchmark index.\n- In terms of distribution shape, TBTF displays **near-zero skewness** and **moderate excess kurtosis**, suggesting symmetric but fat-tailed returns. This is consistent with the earlier observation that pre-2010 TBTF returns resembled a bell curve with heavy tails, whereas NDX was left-skewed and more extreme in both tails.\n\nTaken together, these results indicate that during the pre-QE, industrial-cycle-driven market regime, the structural logic behind TBTF—capital lock-in and size dominance—did not translate into superior returns. Instead, diversification (as in DJI) and tech momentum (as in NDX) dominated portfolio performance.\n\n\n### Interpretation: Post-2010 Period\n\n\n```{python}\n\nreturns_dict_post2010 = {\n    'TBTF': tbtf_returns_post2010,\n    'DIA': post_index['DIA'],\n    'QQQ': post_index['QQQ'],\n    'SPY': post_index['SPY'],\n    'VTI': post_index['VTI']\n}\n\n#| tbl-cap: \"Risk-Adjusted Performance Comparison (Post-2010)\"\ntbtf.generate_performance_table(returns_dict_post2010).sort_values(by='Expected CRRA', ascending=False)\n\n```\n\nThe post-2010 performance metrics tell a dramatically different story. In this regime—characterized by sustained quantitative easing, historically low interest rates, and capital concentration—the TBTF strategy not only outperforms all benchmark portfolios in raw returns, but does so **decisively across all risk-adjusted dimensions**.\n\n- **Annualized return** for TBTF reaches **35.8%**, more than twice that of QQQ (16.9%) and over three times that of SPY, VTI, and DIA (all below 11%). \n- The **Sharpe ratio** of TBTF (1.57) is by far the highest, indicating a return per unit of volatility unmatched by any benchmark. More notably, the **Sortino ratio** (2.21) and **Omega ratio** (2.17) reveal TBTF’s **asymmetric protection against downside**, a signature feature of its convex payoff structure.\n- **Maximum drawdown** is relatively modest at -21.0%, despite the high return level, and the **Calmar ratio** (1.70) reflects this efficiency. By comparison, QQQ suffers a deeper drawdown (-33.1%) with only a third of the Calmar ratio.\n- Crucially, the **Expected CRRA utility** for TBTF is **+0.0214**, more than double that of QQQ (+0.0103), and significantly above other diversified portfolios (SPY: +0.0067, VTI: +0.0065, DIA: +0.0059). For a moderately risk-averse investor ($\\gamma = 3$), TBTF represents a clear welfare-maximizing choice.\n- From a distributional perspective, TBTF shows **mild negative skewness (Fisher: -0.35)** and **positive excess kurtosis (1.13)**, consistent with earlier evidence of **bimodality and tail concentration**. In contrast, SPY and VTI are more symmetric but exhibit thinner tails, which limits their upside potential.\n- QQQ, while historically strong, demonstrates a **flattened distribution with lower Omega and Sortino ratios**, suggesting diminished downside protection relative to TBTF in recent years.\n\nThese results reinforce the view that the post-2010 market environment systematically rewarded capital dominance over traditional diversification or momentum strategies. TBTF’s success is not just statistically significant, but economically meaningful across every major dimension of portfolio evaluation—returns, risk, asymmetry, drawdowns, and investor utility.\n\n\n## Drawdown and Turnover\n\nIn this section, we evaluate the **downside risk exposure** and **implementation feasibility** of the TBTF strategy. Two key dimensions are analyzed:\n\n- **Maximum Drawdown**: Measures the largest peak-to-trough decline in cumulative return over the evaluation period.\n- **Portfolio Turnover**: Assesses the degree of rebalancing required, with lower turnover implying lower transaction costs and higher implementability.\n\n### Drawdown Dynamics\n\n> While TBTF suffered deeper losses than ^DJI during the 2008 crisis, its post-2010 drawdown profile proved significantly more resilient than traditional style portfolios and benchmark ETFs, with a rapid recovery trajectory by 2023.\n\n```{python}\n\nimport matplotlib.pyplot as plt\nimport matplotlib.dates as mdates\n\ndef compute_drawdown(return_series: pd.Series) -> pd.Series:\n    cumulative = (1 + return_series).cumprod()\n    peak = cumulative.cummax()\n    drawdown = (cumulative - peak) / peak\n    return drawdown\n\ndef plot_drawdown(tbtf_returns_raw, benchmark_df, title=\"Drawdown Profile\"):\n    plt.figure(figsize=(10, 4))\n\n    # --- TBTF 처리 ---\n    if isinstance(tbtf_returns_raw, pd.DataFrame):\n        if 'date' in tbtf_returns_raw.columns:\n            tbtf_returns_raw = tbtf_returns_raw.set_index(pd.to_datetime(tbtf_returns_raw['date']))\n        tbtf_returns = tbtf_returns_raw.select_dtypes(include='number').iloc[:, 0]\n    elif isinstance(tbtf_returns_raw, pd.Series):\n        tbtf_returns = tbtf_returns_raw\n    else:\n        raise TypeError(\"tbtf_returns_raw must be DataFrame or Series.\")\n\n    tbtf_returns.index = pd.to_datetime(tbtf_returns.index)\n    tbtf_drawdown = compute_drawdown(tbtf_returns)\n    plt.plot(tbtf_drawdown.index, tbtf_drawdown.values, label='TBTF', color='black', linewidth=2)\n\n    # --- 벤치마크 DataFrame 처리 ---\n    if 'date' in benchmark_df.columns:\n        benchmark_df = benchmark_df.set_index(pd.to_datetime(benchmark_df['date']))\n    else:\n        benchmark_df.index = pd.to_datetime(benchmark_df.index)\n\n    benchmark_df = benchmark_df.select_dtypes(include='number')  # 숫자만\n\n    for col in benchmark_df.columns:\n        series = benchmark_df[col].reindex(tbtf_returns.index)\n        if series.isna().all():\n            continue  # 완전히 비어있으면 skip\n        drawdown = compute_drawdown(series)\n        plt.plot(drawdown.index, drawdown.values, label=col, alpha=0.7)\n\n    # --- x축 날짜 포맷 ---\n    ax = plt.gca()\n    ax.xaxis.set_major_locator(mdates.YearLocator())\n    ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y'))\n    plt.xticks(rotation=45)\n\n    # --- 마무리 ---\n    plt.title(title)\n    plt.ylabel(\"Drawdown\")\n    plt.xlabel(\"Date\")\n    plt.legend()\n    plt.grid(True)\n    plt.tight_layout()\n    plt.show()\n\n```\n\n#### Pre-2010 Period (2000–2009)\n```{python}\nplot_drawdown(results_pre['returns'], pre_index, title=\"Drawdown Profile (Pre-2010)\")\n```\nDuring the first decade, the TBTF strategy underperformed the Dow Jones Industrial Average (^DJI) in terms of drawdown resilience. While TBTF, ^DJI, and ^NDX all exhibited relatively similar patterns prior to the 2008 Global Financial Crisis, the drawdown plot reveals that TBTF experienced a sharper decline during the crisis episode. This suggests that TBTF’s concentrated exposure to the largest-cap firms provided limited diversification benefit during systemic tail events, particularly in contrast to the more balanced composition of the ^DJI.\n\n\n#### Post-2010 Period (2014–2023)\n\n```{python}\nplot_drawdown(results_post['returns'], post_index, title=\"Drawdown Profile (Post-2010)\")\nplot_drawdown(results_post['returns'], post_ff, title=\"Drawdown Profile (Post-2010)\")\n\n```\n\nIn contrast, during the second decade, TBTF demonstrated superior drawdown performance relative to all benchmark ETFs, particularly until late 2021. The strategy maintained shallow drawdowns through several volatility cycles, including the COVID-19 shock and inflation-driven rate adjustments, reflecting its structural bias toward persistent market leaders.\n\nHowever, in late 2021, TBTF experienced a notable drawdown phase, closely mirrored by the QQQ, indicating common exposure to high-growth tech stocks. Despite this synchronized decline, both TBTF and QQQ rebounded strongly by 2023, surpassing prior peaks.\n\nNotably, the Fama-French style-sorted portfolios (ME×PRIOR) exhibited deeper and more persistent drawdowns throughout the post-2010 period. These portfolios consistently underperformed TBTF in drawdown magnitude, highlighting the limitations of conventional size- and momentum-based constructions in capturing the structural dominance embedded in TBTF’s selection mechanism.\n\n\n\n### TBTF Turnover\n\n```{python}\nimport matplotlib.pyplot as plt\nimport matplotlib.dates as mdates\n\ndef plot_turnover(turnover_df, title=\"TBTF Turnover Over Time\"):\n    df = turnover_df.copy()\n    df['rebalance_date'] = pd.to_datetime(df['rebalance_date'])\n    df.set_index('rebalance_date', inplace=True)\n\n    plt.figure(figsize=(10, 3))\n    plt.plot(df.index, df['turnover'], marker='o', color='darkgreen', linewidth=1.5)\n\n    # x축 날짜 format\n    ax = plt.gca()\n    ax.xaxis.set_major_locator(mdates.YearLocator())\n    ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y'))\n    plt.xticks(rotation=45)\n\n    plt.title(title)\n    plt.ylabel(\"Turnover (sum of abs weight changes)\")\n    plt.xlabel(\"Rebalance Date\")\n    plt.grid(True)\n    plt.tight_layout()\n    plt.show()\n\n```\n\n```{python}\n# Pre-2010 turnover plot\nplot_turnover(results_pre['turnover'].iloc[:-1], title=\"TBTF Turnover (Pre-2010)\")\n\n# Post-2010 turnover plot\nplot_turnover(results_post['turnover'].iloc[:-1], title=\"TBTF Turnover (Post-2010)\")\n\n```\n\nThe TBTF strategy rebalances quarterly, yet maintains a remarkably steady turnover profile across both subperiods, highlighting its structural persistence and practical implementability.\n\n| Period      | Mean Turnover | Std Dev |\n|-------------|---------------|---------|\n| Pre-2010    | 0.22          | 0.12    |\n| Post-2010   | 0.15          | 0.10    |\n\nThis low and stable turnover suggests that, although the strategy updates weights every three months, the **actual reallocation of capital is limited**. This is particularly meaningful given TBTF’s concentrated structure: the top 10 stocks by market capitalization.\n\nTo further explore the internal mechanics of turnover, we examine the group-rank positions of stocks entering and exiting the portfolio:\n\n- The average **`max_diff_group_rank`** is approximately **1–2**, indicating that stocks removed from the TBTF portfolio were typically ranked **9th or 10th** before exit.  \n- The average **`min_diff_group_rank`** is approximately **3–3.5**, suggesting that newly entering stocks typically displaced members ranked around **6th or 7th**.\n\nThis pattern implies a **core–fringe structure** within the TBTF portfolio:  \nthe **top-ranked firms (1st–5th)** exhibit strong persistence, while changes are concentrated at the margin of the selection, reducing both instability and turnover-related costs.\n\n\n\n## Implications\n\nThe TBTF strategy consistently delivers strong out-of-sample performance, characterized by high risk-adjusted returns, stable drawdowns, and low turnover. These patterns persist across both pre- and post-2010 market regimes and cannot be explained by conventional size or momentum factors.\n\nWhat distinguishes TBTF is not merely statistical outperformance but its reflection of **a persistent capital hierarchy**, in which dominant firms retain market share through institutional mechanisms rather than pure productivity or risk-taking.\n\nWhereas traditional models explain return premia through exposure to priced risk, TBTF accumulates return through insulation from risk—via passive flows, platform effects, and embedded expectations. In this sense, **market power does not demand a premium—it neutralizes the need for one**.\n\nThis invites a reframing of modern asset pricing:  \n> *Return without risk is no longer a puzzle, but a feature of financial capitalism.*\n\nReaders seeking formal modeling of regime persistence and capital asymmetry are referred to [Section 4](4_4_structure.qmd). Here, we have focused on empirical validation, leaving latent structure estimation to the structural section.\n\nIn the following section, we assess whether TBTF’s performance is **robust to alternative specifications**: selection cutoffs, rebalancing intervals, weighting schemes, and estimation windows. This stress-testing is essential to distinguish true structural effects from parameter-driven artifacts.\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":false,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"jupyter"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"toc":true,"number-sections":true,"output-file":"4_6_performance.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.22","author":"gitSAM","date":"2025-03-31","bibliography":["references.bib"],"jupyter":"python3","theme":"cosmo","title":"06 Performance"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}